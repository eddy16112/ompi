@SET_MAKE@

AM_CPPFLAGS = @common_cuda_CPPFLAGS@
srcdir = @srcdir@
top_builddir = @top_builddir@
top_srcdir = @top_srcdir@
VPATH = @srcdir@

NVCC       = nvcc
ARCH       = @AR@
ARCHFLAGS  = cr
STLIB     ?= opal_datatype_cuda_kernel.a
DYLIB     ?= opal_datatype_cuda_kernel.so
EXTLIB     = -L$(top_builddir)/opal/datatype/.libs -ldatatype -L$(top_builddir)/opal/.libs -lopen-pal -L/usr/local/cuda/lib -lcuda
subdir     = opal/datatype/cuda

CC = nvcc
CFLAGS  = -I$(top_builddir)/opal/include -I$(top_srcdir)/opal/include -I$(top_builddir) -I$(top_srcdir) -gencode arch=compute_35,code=sm_35 --compiler-options '-fPIC @CFLAGS@'
LDFLAGS = -shared --compiler-options '-fPIC @LDFLAGS@'

SRC := \
    opal_datatype_cuda.cu \
    opal_datatype_pack_cuda_kernel.cu \
    opal_datatype_pack_cuda_wrapper.cu \
    opal_datatype_unpack_cuda_kernel.cu \
    opal_datatype_unpack_cuda_wrapper.cu

OBJ := $(SRC:.cu=.o)

.PHONY: all clean cleanall

all: Makefile $(STLIB) $(DYLIB)

Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
	@case '$?' in \
	  *config.status*) \
	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
	  *) \
	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe)'; \
	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ $(am__depfiles_maybe);; \
	esac;

$(STLIB): $(OBJ)
	$(ARCH) $(ARCHFLAGS) $@ $(OBJ) 
	@RANLIB@ $@

$(DYLIB): $(OBJ)
	$(NVCC) $(LDFLAGS) $(EXTLIB) -o $(DYLIB) $(OBJ)

%.o: %.cu
	$(NVCC) $(CFLAGS) $(EXTLIB) $(INC) -c $< -o $@ 

install: $(DYLIB)
	cp -f $(DYLIB) @OMPI_WRAPPER_LIBDIR@/

clean:
	rm -f $(OBJ)

cleanall: clean
	rm -f $(STLIB) $(DYLIB)
